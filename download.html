<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تحميل التطبيق - دليل الصيد الليبي</title>

    <!-- خطوط وأيقونات -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.38.0/dist/umd/supabase.min.js"></script>

    <!-- الأنماط -->
    <link rel="stylesheet" href="assets/css/style.css">

    <style>
        /* أنماط شاشة التحميل */
        .download-content {
            padding: 80px 0 60px;
            min-height: 100vh;
            background: linear-gradient(135deg, rgba(25, 118, 243, 0.03), rgba(0, 51, 102, 0.02));
        }

        .download-header {
            text-align: center;
            margin-bottom: 50px;
        }

        .download-header h1 {
            font-size: 42px;
            font-weight: 900;
            margin-bottom: 14px;
            background: linear-gradient(135deg, var(--accent), var(--primary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .download-header p {
            color: var(--sub-text);
            font-size: 18px;
            max-width: 600px;
            margin: 0 auto;
        }

        /* أيقونة التطبيق العائمة */
        .app-icon {
            width: 120px;
            height: 120px;
            margin: 0 auto 30px;
            border-radius: 25px;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 20px 40px rgba(25, 118, 243, 0.3);
            animation: float 3s ease-in-out infinite;
        }

        .app-icon img {
            width: 150px;
            height: 150px;
            border-radius: 15px;
        }

        @keyframes float {

            0%,
            100% {
                transform: translateY(0px);
            }

            50% {
                transform: translateY(-10px);
            }
        }

        /* معلومات الإصدار */
        .version-info {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 30px;
            margin-bottom: 40px;
            box-shadow: 0 10px 30px var(--shadow);
            border: 1px solid var(--border);
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: rgba(25, 118, 243, 0.05);
            border-radius: 10px;
            border-right: 3px solid var(--primary);
        }

        .info-item .label {
            font-weight: 600;
            color: var(--text);
        }

        .info-item .value {
            color: var(--primary);
            font-weight: 700;
        }

        /* خطوات التحميل */
        .download-steps {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 30px;
            margin-bottom: 40px;
            box-shadow: 0 10px 30px var(--shadow);
            border: 1px solid var(--border);
        }

        .step {
            display: flex;
            align-items: flex-start;
            gap: 20px;
            margin-bottom: 30px;
            padding: 25px;
            border-radius: 15px;
            background: var(--bg);
            transition: var(--transition);
            border: 2px solid transparent;
        }

        .step.active {
            border-color: var(--primary);
            background: rgba(25, 118, 243, 0.05);
            transform: translateX(-5px);
        }

        .step-number {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: 700;
            flex-shrink: 0;
        }

        .step-content {
            flex: 1;
        }

        .step-content h3 {
            color: var(--accent);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .step-content p {
            color: var(--sub-text);
            margin-bottom: 15px;
        }

        /* الأزرار */
        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: var(--radius);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            font-family: "Tajawal", sans-serif;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
        }

        .subscribe-btn {
            background: linear-gradient(135deg, #FF0000, #CC0000);
            color: white;
            box-shadow: 0 5px 15px rgba(255, 0, 0, 0.3);
        }

        .subscribe-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 0, 0, 0.4);
        }

        .download-btn {
            background: linear-gradient(135deg, var(--primary), var(--accent));
            color: white;
            box-shadow: 0 5px 15px rgba(25, 118, 243, 0.3);
        }

        .download-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(25, 118, 243, 0.4);
        }

        .btn:disabled {
            background: var(--sub-text);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* تأثير النبض */
        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }

            100% {
                transform: scale(1);
            }
        }

        /* حالة الاشتراك */
        .subscription-status {
            display: none;
            align-items: center;
            gap: 10px;
            padding: 12px 20px;
            background: linear-gradient(135deg, #4CAF50, #2E7D32);
            color: white;
            border-radius: var(--radius);
            margin-top: 15px;
        }

        .status-check {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: white;
            color: #4CAF50;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        /* الميزات */
        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-top: 30px;
        }

        .feature {
            background: var(--card-bg);
            padding: 25px;
            border-radius: var(--radius);
            text-align: center;
            box-shadow: 0 5px 15px var(--shadow);
            transition: var(--transition);
            border: 1px solid var(--border);
        }

        .feature:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px var(--shadow-hover);
        }

        .feature-icon {
            width: 70px;
            height: 70px;
            border-radius: 20px;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            color: white;
            font-size: 28px;
        }

        .feature h3 {
            color: var(--accent);
            margin-bottom: 10px;
        }

        .feature p {
            color: var(--sub-text);
            line-height: 1.6;
        }

        /* النافذة المنبثقة */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
        }

        /* ========== DOWNLOAD ========== */
        .download {
            padding: 64px 0;
            text-align: center
        }

        .download-buttons {
            display: flex;
            justify-content: center;
            gap: 18px;
            margin-top: 26px;
            flex-wrap: wrap
        }

        .store-btn {
            display: flex;
            align-items: center;
            gap: 12px;
            background: var(--card-bg);
            color: var(--text);
            padding: 12px 18px;
            border-radius: 12px;
            text-decoration: none;
            font-weight: 700;
            box-shadow: 0 8px 18px var(--shadow);
            transition: var(--transition);
            cursor: pointer;
        }

        .store-btn:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 28px var(--shadow-hover)
        }

        .store-icon {
            font-size: 22px
        }

        .store-text span {
            display: block;
            font-size: 12px;
            color: var(--sub-text)
        }

        .store-text strong {
            font-size: 15px
        }

        .modal.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 40px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            transform: scale(0.7);
            transition: var(--transition);
        }

        .modal.active .modal-content {
            transform: scale(1);
        }

        .modal-content h3 {
            color: var(--accent);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .modal-content p {
            color: var(--sub-text);
            margin-bottom: 25px;
            line-height: 1.6;
        }

        /* شريط التقدم */
        .progress-container {
            width: 100%;
            height: 8px;
            background: var(--border);
            border-radius: 4px;
            margin: 25px 0;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            border-radius: 4px;
            width: 0%;
            transition: width 0.3s ease;
        }

        .modal-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .secondary-btn {
            background: var(--sub-text);
            color: white;
        }

        .confirm-btn {
            background: linear-gradient(135deg, #4CAF50, #2E7D32);
            color: white;
        }

        /* رسائل النجاح */
        .success-message {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #4CAF50, #2E7D32);
            color: white;
            padding: 15px 25px;
            border-radius: var(--radius);
            box-shadow: 0 10px 30px rgba(76, 175, 80, 0.3);
            z-index: 3000;
            animation: slideInRight 0.3s ease;
        }

        .info-message {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #2196F3, #1976D2);
            color: white;
            padding: 15px 25px;
            border-radius: var(--radius);
            box-shadow: 0 10px 30px rgba(33, 150, 243, 0.3);
            z-index: 3000;
            animation: slideInRight 0.3s ease;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
            }

            to {
                transform: translateX(0);
            }
        }

        /* متطلبات النظام */
        .system-requirements {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 30px;
            margin: 40px 0;
            box-shadow: 0 10px 30px var(--shadow);
            border: 1px solid var(--border);
        }

        .requirements-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .requirement {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: rgba(25, 118, 243, 0.05);
            border-radius: 10px;
        }

        .requirement i {
            color: var(--primary);
            font-size: 20px;
        }

        @media (max-width: 768px) {
            .download-header h1 {
                font-size: 32px;
            }

            .info-grid {
                grid-template-columns: 1fr;
            }

            .features-grid {
                grid-template-columns: 1fr;
            }

            .step {
                flex-direction: column;
                text-align: center;
            }

            .modal-actions {
                flex-direction: column;
            }

            .modal-content {
                padding: 25px;
            }
        }

        /* ========== HERO ========== */
        .hero {
            padding: 70px 0 40px;
            text-align: center;

        }

        .hero-content {
            max-width: 900px;
            margin: 0 auto
        }

        .hero h2 {
            font-size: 42px;
            font-weight: 900;
            margin-bottom: 14px;
            background: linear-gradient(135deg, var(--accent), var(--primary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent
        }

        .hero p {
            font-size: 18px;
            color: var(--sub-text);
            margin: 0 auto 28px;
            max-width: 720px
        }

        /* screenshots */
        .app-screenshots {
            display: flex;
            justify-content: center;
            gap: 18px;
            flex-wrap: wrap;
            margin-top: 20px
        }

        .screenshot {
            width: 90vw;
            max-width: 350;
            border-radius: 18px;
            box-shadow: 0 14px 30px rgba(0, 0, 0, 0.12);
            transition: var(--transition)
        }

        .screenshot:hover {
            transform: translateY(-10px)
        }
    </style>
</head>

<body>
    <!-- سيتم تحميل الهيدر تلقائياً هنا -->
    <div id="header-container"></div>

    <!-- محتوى الصفحة -->
    <main class="page-content">
        <div class="container">
            <section class="download-content">
                <!-- رأس الصفحة -->
                <section class="hero" id="home">
                    <div class="download-header">
                        <div class="app-icon">
                            <img src="assist/1.png" alt="أيقونة دليل الصيد الليبي">
                        </div>

                    </div>
                    <div class="container hero-content">
                        <h2>دليلك الشامل لعالم الصيد في ليبيا</h2>
                        <p>اكتشف أفضل أماكن الصيد، تعرف على أحوال الطقس، استخدم أدوات متقدمة للغطس الحر، وشارك
                            تجاربك مع مجتمع
                            الصيادين.</p>

                        <div class="app-screenshots" aria-hidden="false">
                            <img src="assist/Untitled-1.jpg" alt="شاشة التطبيق 1" class="screenshot">

                        </div>
                    </div>
                </section>
                <!-- DOWNLOAD -->
                <section class="download" id="download">

                    <div class="section-title">
                        <h2>حمّل التطبيق الآن</h2>
                        <p>انضم إلى آلاف الصيادين المحترفين واستمتع بتجربة صيد استثنائية</p>
                    </div>

                    <div class="download-buttons">
                        <a href="#" class="store-btn google-play-btn" aria-label="تحميل من جوجل بلاي">
                            <i class="fab fa-google-play store-icon"></i>
                            <div class="store-text">
                                <span>حمّله من</span>
                                <strong>Google Play</strong>
                            </div>
                        </a>

                        <a href="#" class="store-btn app-store-btn" aria-label="تحميل من ابل ستور">
                            <i class="fab fa-apple store-icon"></i>
                            <div class="store-text">
                                <span>حمّله من</span>
                                <strong>App Store</strong>
                            </div>
                        </a>
                        <a href="#" class="store-btn direct-download-btn" aria-label="تحميل مباشر">
                            <i class="fa-solid fa-download"></i>
                            <div class="store-text">
                                <span>حمّله من</span>
                                <strong>تحميل مباشر</strong>
                            </div>
                        </a>
                    </div>

                </section>
                <!-- معلومات الإصدار -->
                <section class="version-info">
                    <h2 style="color: var(--accent); margin-bottom: 20px; text-align: center;">معلومات الإصدار</h2>
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="label">رقم الإصدار:</span>
                            <span class="value" id="versionNumber">1.0.0</span>
                        </div>
                        <div class="info-item">
                            <span class="label">تاريخ التحديث:</span>
                            <span class="value" id="updateDate">2024-01-01</span>
                        </div>
                        <div class="info-item">
                            <span class="label">حجم الملف:</span>
                            <span class="value" id="fileSize">45 MB</span>
                        </div>
                        <div class="info-item">
                            <span class="label">عدد التحميلات:</span>
                            <span class="value" id="downloadCount">0</span>
                        </div>
                    </div>
                </section>

                <!-- متطلبات النظام -->
                <section class="system-requirements">
                    <h2 style="color: var(--accent); margin-bottom: 20px; text-align: center;">متطلبات النظام</h2>
                    <div class="requirements-grid">
                        <div class="requirement">
                            <i class="fab fa-android"></i>
                            <div>
                                <strong>أندرويد 8.0+</strong>
                                <p style="margin: 5px 0 0; color: var(--sub-text); font-size: 14px;">أو أحدث</p>
                            </div>
                        </div>
                        <div class="requirement">
                            <i class="fas fa-memory"></i>
                            <div>
                                <strong>50 MB مساحة</strong>
                                <p style="margin: 5px 0 0; color: var(--sub-text); font-size: 14px;">مساحة تخزين</p>
                            </div>
                        </div>
                        <div class="requirement">
                            <i class="fas fa-wifi"></i>
                            <div>
                                <strong>اتصال إنترنت</strong>
                                <p style="margin: 5px 0 0; color: var(--sub-text); font-size: 14px;">للميزات المتقدمة
                                </p>
                            </div>
                        </div>
                        <div class="requirement">
                            <i class="fas fa-map-marker-alt"></i>
                            <div>
                                <strong>خدمة الموقع</strong>
                                <p style="margin: 5px 0 0; color: var(--sub-text); font-size: 14px;">لخرائط الصيد</p>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- خطوات التحميل -->
                <section class="download-steps">
                    <h2 style="color: var(--accent); margin-bottom: 30px; text-align: center;">خطوات التحميل</h2>

                    <div class="step" id="step1">
                        <div class="step-number">1</div>
                        <div class="step-content">
                            <h3><i class="fab fa-youtube"></i> اشترك في قناتنا على يوتيوب</h3>
                            <p>للحصول على آخر التحديثات والنصائح حول الصيد والغطس الحر</p>
                            <button class="btn subscribe-btn pulse" id="subscribeBtn">
                                <i class="fab fa-youtube"></i> اشترك في القناة
                            </button>
                            <div class="subscription-status" id="subscriptionStatus">
                                <span class="status-check">✓</span>
                                <span>تم الاشتراك بنجاح!</span>
                            </div>
                        </div>
                    </div>

                    <div class="step" id="step2">
                        <div class="step-number">2</div>
                        <div class="step-content">
                            <h3><i class="fas fa-download"></i> تأكيد الاشتراك</h3>
                            <p>تم التحقق من اشتراكك، يمكنك الآن تحميل التطبيق</p>
                            <button class="btn download-btn" id="stepDownloadBtn">
                                <i class="fas fa-download"></i> تحميل الآن
                            </button>
                        </div>
                    </div>
                </section>

                <!-- الميزات الرئيسية -->
                <section class="features">
                    <h2 style="color: var(--accent); margin-bottom: 30px; text-align: center;">الميزات الرئيسية</h2>
                    <div class="features-grid">
                        <div class="feature">
                            <div class="feature-icon"><i class="fas fa-map-marked-alt"></i></div>
                            <h3>خرائط أماكن الصيد</h3>
                            <p>قاعدة بيانات محدثة بأفضل مواقع الصيد على طول الساحل الليبي</p>
                        </div>
                        <div class="feature">
                            <div class="feature-icon"><i class="fas fa-fish"></i></div>
                            <h3>دليل الأسماك المحلية</h3>
                            <p>تعرف على أنواع الأسماك الشائعة في ليبيا ومواسم ظهورها</p>
                        </div>
                        <div class="feature">
                            <div class="feature-icon"><i class="fas fa-cloud-sun"></i></div>
                            <h3>توقعات الطقس البحري</h3>
                            <p>معلومات مباشرة عن حالة البحر، سرعة الرياح، ودرجة الحرارة</p>
                        </div>
                        <div class="feature">
                            <div class="feature-icon"><i class="fas fa-water"></i></div>
                            <h3>مواعيد المد والجزر</h3>
                            <p>جدول دقيق لفترات المد والجزر التي تؤثر على نشاط الأسماك</p>
                        </div>
                    </div>
                </section>
            </section>
        </div>
    </main>

    <!-- نافذة التأكيد -->
    <div class="modal" id="confirmationModal">
        <div class="modal-content">
            <h3><i class="fab fa-youtube"></i> تأكيد الاشتراك</h3>
            <p>يرجى الانتقال إلى قناتنا على يوتيوب والاشتراك، ثم العودة إلى هذه الصفحة والضغط على زر التأكيد.</p>
            <div class="progress-container">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            <div class="modal-actions">
                <button class="btn secondary-btn" id="cancelBtn">
                    <i class="fas fa-times"></i> إلغاء
                </button>
                <button class="btn confirm-btn" id="confirmBtn">
                    <i class="fas fa-check"></i> لقد اشتركت
                </button>
            </div>
        </div>
    </div>

    <!-- سيتم تحميل الفوتر تلقائياً هنا -->
    <div id="footer-container"></div>

    <!-- السكريبتات -->
    <script src="shared/config.js"></script>
    <script src="assets/js/main.js"></script>
    <script>
        // المتغيرات العامة
        let appVersion = {
            version: "1.0.0",
            update_date: "2024-01-01",
            file_size: "45 MB"
        };

        // تهيئة الصفحة
        document.addEventListener('DOMContentLoaded', function () {
            initSupabase();
            loadAppInfo();
            setupEventListeners();
            checkSubscriptionStatus();
        });

        // تهيئة Supabase
        function initSupabase() {
            try {
                if (typeof supabase !== 'undefined' && window.supabaseClient) {
                    console.log('✅ Supabase initialized for download page');
                } else {
                    console.error('❌ Supabase client not available');
                }
            } catch (err) {
                console.error('❌ Supabase init error:', err);
            }
        }

        // تحميل معلومات التطبيق
        async function loadAppInfo() {
            try {
                if (!window.supabaseClient) {
                    console.error('❌ Supabase client not initialized');
                    return;
                }

                // جلب آخر إصدار من جدول app_updates
                const { data: versionData, error: versionError } = await window.supabaseClient
                    .from('app_updates')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(1);

                if (!versionError && versionData && versionData.length > 0) {
                    const latestVersion = versionData[0];
                    appVersion = {
                        version: latestVersion.version,
                        update_date: latestVersion.created_at,
                        file_size: "45 MB",
                        file_url: latestVersion.download_url
                    };

                    document.getElementById('versionNumber').textContent = appVersion.version;
                    document.getElementById('updateDate').textContent = new Date(appVersion.update_date).toLocaleDateString('ar-SA');
                    document.getElementById('fileSize').textContent = appVersion.file_size;

                    // جلب عدد التحميلات من جدول download_counts
                    const { data: countData, error: downloadError } = await window.supabaseClient
                        .from('download_counts')
                        .select('count')
                        .eq('version', appVersion.version)
                        .single();

                    if (!downloadError && countData) {
                        document.getElementById('downloadCount').textContent = countData.count;
                    } else {
                        document.getElementById('downloadCount').textContent = '0';
                    }

                } else {
                    // استخدام القيم الافتراضية إذا لم توجد بيانات
                    document.getElementById('versionNumber').textContent = appVersion.version;
                    document.getElementById('updateDate').textContent = appVersion.update_date;
                    document.getElementById('fileSize').textContent = appVersion.file_size;
                    document.getElementById('downloadCount').textContent = '0';
                }

            } catch (error) {
                console.error('❌ Error loading app info:', error);
                // استخدام القيم الافتراضية في حالة الخطأ
                document.getElementById('versionNumber').textContent = appVersion.version;
                document.getElementById('updateDate').textContent = appVersion.update_date;
                document.getElementById('fileSize').textContent = appVersion.file_size;
                document.getElementById('downloadCount').textContent = '0';
            }
        }

        // إعداد مستمعي الأحداث
        function setupEventListeners() {
            // أزرار المتاجر
            document.querySelector('.google-play-btn').addEventListener('click', handleStoreDownload);
            document.querySelector('.app-store-btn').addEventListener('click', handleStoreDownload);
            document.querySelector('.direct-download-btn').addEventListener('click', downloadApp);

            // أزرار الخطوات
            document.getElementById('subscribeBtn').addEventListener('click', openSubscriptionModal);
            document.getElementById('confirmBtn').addEventListener('click', confirmSubscription);
            document.getElementById('cancelBtn').addEventListener('click', closeSubscriptionModal);
            document.getElementById('stepDownloadBtn').addEventListener('click', downloadApp);
        }

        // معالجة تحميل المتاجر
        function handleStoreDownload(event) {
            event.preventDefault();
            const storeName = event.currentTarget.querySelector('strong').textContent;
            showInfoMessage(`سيتم توفير التطبيق على ${storeName} قريباً. شكراً لاهتمامكم!`);
        }

        // تنزيل التطبيق مباشر
        async function downloadApp(event) {
            if (event) event.preventDefault();

            try {
                if (!window.supabaseClient) {
                    showSuccessMessage('خطأ في الاتصال. حاول مرة أخرى.');
                    return;
                }

                const version = appVersion.version;

                // 🔹 جلب بيانات النسخة من جدول app_updates
                const { data: versionData, error: fetchError } = await window.supabaseClient
                    .from('app_updates')
                    .select('download_url, version')
                    .eq('version', version)
                    .single();

                if (fetchError || !versionData) {
                    console.warn('⚠️ Version not found in app_updates table');
                    showInfoMessage('الإصدار غير متوفر حالياً. يرجى المحاولة لاحقاً.');
                    return;
                }

                const fileUrl = versionData.download_url;
                let newCount = 1;

                // 🔹 تحديث عداد التحميلات في جدول download_counts
                const { data: countData, error: countError } = await window.supabaseClient
                    .from('download_counts')
                    .select('count')
                    .eq('version', version)
                    .single();

                if (!countError && countData) {
                    // تحديث العداد إذا كان السجل موجوداً
                    newCount = countData.count + 1;
                    const { error: updateError } = await window.supabaseClient
                        .from('download_counts')
                        .update({ count: newCount })
                        .eq('version', version);

                    if (updateError) {
                        console.error('Update count error:', updateError);
                        showInfoMessage('تم البدء بالتحميل!');
                    }
                } else {
                    // إنشاء سجل جديد إذا لم يكن موجوداً
                    const { error: insertError } = await window.supabaseClient
                        .from('download_counts')
                        .insert({
                            version: version,
                            count: 1
                        });

                    if (insertError) {
                        console.error('Insert count error:', insertError);
                        showInfoMessage('تم البدء بالتحميل!');
                    }
                }

                // 🔹 تحديث العرض على الصفحة
                document.getElementById('downloadCount').textContent = newCount;

                // 🔹 بدء التحميل المباشر
                startDirectDownload(fileUrl);

            } catch (error) {
                console.error('❌ Error downloading app:', error);
                showSuccessMessage('بدأ تحميل التطبيق! إذا لم يبدأ التحميل تحقق من نافذة التنزيلات.');
            }
        }

        // بدء التحميل المباشر
        function startDirectDownload(fileUrl) {
            if (!fileUrl) {
                alert("رابط التحميل غير متوفر حالياً. يرجى المحاولة لاحقاً.");
                return;
            }

            try {
                // إنشاء رابط تحميل مخفي
                const link = document.createElement("a");
                link.href = fileUrl;
                link.download = "دليل_الصيد_الليبي_" + appVersion.version + ".apk";
                link.target = "_blank";
                link.style.display = "none";

                // إضافة الرابط للصفحة والنقر عليه
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                showSuccessMessage('بدأ التحميل! تحقق من نافذة التنزيلات في متصفحك.');

            } catch (error) {
                console.error('Download error:', error);
                // بديل: فتح الرابط في نافذة جديدة
                window.open(fileUrl, '_blank');
            }
        }

        // فتح نافذة الاشتراك
        function openSubscriptionModal() {
            document.getElementById('confirmationModal').classList.add('active');

            const channelId = "UCY1cREXhxupNmNPHbX6ESMg";
            const youtubeAppUrl = "vnd.youtube://channel/" + channelId;
            const youtubeWebUrl = "https://www.youtube.com/channel/" + channelId + "?sub_confirmation=1";

            // محاولة فتح تطبيق يوتيوب
            const now = Date.now();
            window.location.href = youtubeAppUrl;

            // إذا لم يفتح التطبيق، افتح المتصفح
            setTimeout(() => {
                if (Date.now() - now < 2000) {
                    window.open(youtubeWebUrl, '_blank');
                }
            }, 1500);

            // تعطيل زر التأكيد مؤقتاً
            const confirmBtn = document.getElementById('confirmBtn');
            confirmBtn.disabled = true;
            confirmBtn.innerHTML = '<i class="fas fa-clock"></i> انتظر...';

            // شريط التقدم
            const progressBar = document.getElementById('progressBar');
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += 1;
                progressBar.style.width = `${progress}%`;

                if (progress >= 100) {
                    clearInterval(progressInterval);
                    confirmBtn.disabled = false;
                    confirmBtn.innerHTML = '<i class="fas fa-check"></i> أنا اشتركت';
                }
            }, 200);
        }

        // إغلاق نافذة الاشتراك
        function closeSubscriptionModal() {
            document.getElementById('confirmationModal').classList.remove('active');
        }

        // تأكيد الاشتراك
        function confirmSubscription() {
            localStorage.setItem('youtube_subscribed', 'true');
            localStorage.setItem('subscription_date', new Date().toISOString());
            closeSubscriptionModal();
            activateDownload();
            showSuccessMessage('تم تأكيد الاشتراك بنجاح! يمكنك الآن تحميل التطبيق.');
        }

        // التحقق من حالة الاشتراك
        function checkSubscriptionStatus() {
            if (localStorage.getItem('youtube_subscribed') === 'true') {
                activateDownload();
            }
        }

        // تفعيل زر التحميل
        function activateDownload() {
            document.getElementById('subscriptionStatus').style.display = 'flex';
            document.getElementById('subscribeBtn').style.display = 'none';
            document.getElementById('step2').classList.add('active');
        }

        // رسالة نجاح
        function showSuccessMessage(message) {
            const messageElement = document.createElement('div');
            messageElement.className = 'success-message';
            messageElement.innerHTML = `
            <i class="fas fa-check-circle" style="margin-left: 8px;"></i>
            ${message}
        `;
            document.body.appendChild(messageElement);
            setTimeout(() => messageElement.remove(), 5000);
        }

        // رسالة معلومات
        function showInfoMessage(message) {
            const messageElement = document.createElement('div');
            messageElement.className = 'info-message';
            messageElement.innerHTML = `
            <i class="fas fa-info-circle" style="margin-left: 8px;"></i>
            ${message}
        `;
            document.body.appendChild(messageElement);
            setTimeout(() => messageElement.remove(), 5000);
        }
    </script>
</body>

</html>
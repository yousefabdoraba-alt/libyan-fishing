<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ - Ø¯Ù„ÙŠÙ„ Ø§Ù„ØµÙŠØ¯ Ø§Ù„Ù„ÙŠØ¨ÙŠ</title>
    
    <!-- Ø®Ø·ÙˆØ· ÙˆØ£ÙŠÙ‚ÙˆÙ†Ø§Øª -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.38.0/dist/umd/supabase.min.js"></script>

    <!-- Ø§Ù„Ø£Ù†Ù…Ø§Ø· -->
    <link rel="stylesheet" href="assets/css/style.css">
    
    <style>
        /* Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ - Ù†ÙØ³ Ø§Ù„Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© */
        .support-content {
            padding: 80px 0 60px;
        }

        .support-header {
            text-align: center;
            margin-bottom: 50px;
        }

        .support-header h1 {
            font-size: 42px;
            font-weight: 900;
            margin-bottom: 14px;
            background: linear-gradient(135deg, var(--accent), var(--primary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .support-header p {
            color: var(--sub-text);
            font-size: 18px;
            max-width: 600px;
            margin: 0 auto;
        }

        .auth-required {
            background: linear-gradient(135deg, rgba(255, 152, 0, 0.1), rgba(255, 152, 0, 0.05));
            border: 2px solid #ff9800;
            border-radius: var(--radius);
            padding: 30px;
            text-align: center;
            margin-bottom: 40px;
            display: none;
        }

        .auth-required i {
            font-size: 48px;
            color: #ff9800;
            margin-bottom: 15px;
        }

        .support-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .support-card {
            background: var(--card-bg);
            padding: 30px;
            border-radius: var(--radius);
            text-align: center;
            box-shadow: 0 5px 15px var(--shadow);
            transition: var(--transition);
            border: 1px solid var(--border);
        }

        .support-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px var(--shadow-hover);
        }

        .support-card i {
            font-size: 48px;
            margin-bottom: 20px;
        }

        .support-card.technical i { color: #2196F3; }
        .support-card.account i { color: #4CAF50; }
        .support-card.payment i { color: #FF9800; }
        .support-card.general i { color: #9C27B0; }

        .support-card h3 {
            color: var(--accent);
            margin-bottom: 15px;
        }

        .support-card p {
            color: var(--sub-text);
            margin-bottom: 20px;
        }

        .ticket-form {
            background: var(--card-bg);
            padding: 30px;
            border-radius: var(--radius);
            box-shadow: 0 5px 15px var(--shadow);
            margin-bottom: 40px;
            display: none;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--border);
            border-radius: var(--radius);
            background: var(--card-bg);
            color: var(--text);
            font-size: 16px;
            font-family: "Tajawal", sans-serif;
            transition: var(--transition);
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(25, 118, 243, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 120px;
        }

        .submit-btn {
            background: linear-gradient(135deg, var(--primary), var(--accent));
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: var(--radius);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            font-family: "Tajawal", sans-serif;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(25, 118, 243, 0.3);
        }

        .submit-btn:disabled {
            background: var(--sub-text);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .tickets-list {
            display: none;
        }

        .ticket-item {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px var(--shadow);
            border-left: 4px solid var(--primary);
        }

        .ticket-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .ticket-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text);
            margin: 0;
        }

        .ticket-meta {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .ticket-status {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        .status-open { background: #E3F2FD; color: #1976D2; }
        .status-in-progress { background: #FFF3E0; color: #F57C00; }
        .status-resolved { background: #E8F5E8; color: #2E7D32; }
        .status-closed { background: #F5F5F5; color: #616161; }

        .ticket-date {
            color: var(--sub-text);
            font-size: 14px;
        }

        .ticket-description {
            color: var(--text);
            line-height: 1.6;
            margin-bottom: 15px;
        }

        .ticket-response {
            background: rgba(25, 118, 243, 0.05);
            border-radius: var(--radius);
            padding: 20px;
            margin-top: 15px;
            border-right: 3px solid var(--primary);
        }

        .response-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .response-author {
            font-weight: 600;
            color: var(--primary);
        }

        .response-date {
            color: var(--sub-text);
            font-size: 14px;
        }

        .response-content {
            color: var(--text);
            line-height: 1.6;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--sub-text);
        }

        .loading i {
            font-size: 48px;
            margin-bottom: 15px;
            color: var(--primary);
        }

        .success-message {
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.1), rgba(76, 175, 80, 0.05));
            border: 2px solid #4CAF50;
            border-radius: var(--radius);
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
            display: none;
        }

        .error-message {
            background: linear-gradient(135deg, rgba(244, 67, 54, 0.1), rgba(244, 67, 54, 0.05));
            border: 2px solid #f44336;
            border-radius: var(--radius);
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
            display: none;
        }

        @media (max-width: 900px) {
            .support-header h1 {
                font-size: 32px;
            }
            
            .support-grid {
                grid-template-columns: 1fr;
            }
            
            .ticket-header {
                flex-direction: column;
                align-items: flex-start;
            }
        }

        @media (max-width:768px) {
            .ticket-form,
            .support-card {
                padding: 20px;
            }
            
            .ticket-item {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- Ø³ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‡ÙŠØ¯Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù‡Ù†Ø§ -->
    <div id="header-container"></div>

    <!-- Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØµÙØ­Ø© -->
    <main class="page-content">
        <div class="container">
            <section class="support-content">
                <div class="support-header">
                    <h1>Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ</h1>
                    <p>Ù†Ø­Ù† Ù‡Ù†Ø§ Ù„Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ! Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ø£Ùˆ Ø£Ø±Ø³Ù„ ØªØ°ÙƒØ±Ø© Ø¯Ø¹Ù… Ø¬Ø¯ÙŠØ¯Ø©</p>
                </div>

                <!-- Ø±Ø³Ø§Ù„Ø© Ø·Ù„Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
                <div class="auth-required" id="auth-required">
                    <i class="fas fa-user-lock"></i>
                    <h3>ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h3>
                    <p>ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ù…Ø³Ø¬Ù„Ø§Ù‹ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø®Ø¯Ù…Ø© Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ</p>
                    <button class="submit-btn" onclick="window.openUserModal()" style="margin-top: 15px;">
                        <i class="fas fa-sign-in-alt"></i>
                        ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
                    </button>
                </div>

                <!-- Ø´Ø¨ÙƒØ© Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¯Ø¹Ù… -->
                <div class="support-grid" id="support-grid">
                    <div class="support-card technical" data-category="technical">
                        <i class="fas fa-cogs"></i>
                        <h3>Ù…Ø´Ø§ÙƒÙ„ ÙÙ†ÙŠØ©</h3>
                        <p>Ù…Ø´Ø§ÙƒÙ„ ÙÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ØŒ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ØŒ Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ø£Ø¯Ø§Ø¡</p>
                        <button class="submit-btn" data-category="technical">
                            <i class="fas fa-paper-plane"></i>
                            Ø¥Ø¨Ù„Ø§Øº Ø¹Ù† Ù…Ø´ÙƒÙ„Ø©
                        </button>
                    </div>

                    <div class="support-card account" data-category="account">
                        <i class="fas fa-user-circle"></i>
                        <h3>Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨</h3>
                        <p>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ØŒ Ø§Ø³ØªØ¹Ø§Ø¯Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±ØŒ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨</p>
                        <button class="submit-btn" data-category="account">
                            <i class="fas fa-paper-plane"></i>
                            Ø¥Ø¨Ù„Ø§Øº Ø¹Ù† Ù…Ø´ÙƒÙ„Ø©
                        </button>
                    </div>

                    <div class="support-card payment" data-category="payment">
                        <i class="fas fa-credit-card"></i>
                        <h3>Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ø¯ÙØ¹</h3>
                        <p>Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§ØªØŒ Ø§Ù„ÙÙˆØ§ØªÙŠØ±ØŒ Ø§Ø³ØªØ±Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø¨Ø§Ù„Øº</p>
                        <button class="submit-btn" data-category="payment">
                            <i class="fas fa-paper-plane"></i>
                            Ø¥Ø¨Ù„Ø§Øº Ø¹Ù† Ù…Ø´ÙƒÙ„Ø©
                        </button>
                    </div>

                    <div class="support-card general" data-category="general">
                        <i class="fas fa-question-circle"></i>
                        <h3>Ø§Ø³ØªÙØ³Ø§Ø±Ø§Øª Ø¹Ø§Ù…Ø©</h3>
                        <p>Ø£Ø³Ø¦Ù„Ø©ØŒ Ø§Ù‚ØªØ±Ø§Ø­Ø§ØªØŒ Ø§Ø³ØªÙØ³Ø§Ø±Ø§Øª Ø£Ø®Ø±Ù‰</p>
                        <button class="submit-btn" data-category="general">
                            <i class="fas fa-paper-plane"></i>
                            Ø¥Ø±Ø³Ø§Ù„ Ø§Ø³ØªÙØ³Ø§Ø±
                        </button>
                    </div>
                </div>

                <!-- Ù†Ù…ÙˆØ°Ø¬ Ø¥Ø±Ø³Ø§Ù„ ØªØ°ÙƒØ±Ø© -->
                <div class="ticket-form" id="ticket-form">
                    <h2 style="color: var(--accent); margin-bottom: 25px;">Ø¥Ø±Ø³Ø§Ù„ ØªØ°ÙƒØ±Ø© Ø¯Ø¹Ù… Ø¬Ø¯ÙŠØ¯Ø©</h2>
                    
                    <div class="success-message" id="success-message">
                        <i class="fas fa-check-circle"></i>
                        <h3>ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØ°ÙƒØ±Ø© Ø¨Ù†Ø¬Ø§Ø­!</h3>
                        <p>Ø³ÙŠÙ‚ÙˆÙ… ÙØ±ÙŠÙ‚ Ø§Ù„Ø¯Ø¹Ù… Ø¨Ø§Ù„Ø±Ø¯ Ø¹Ù„ÙŠÙƒ ÙÙŠ Ø£Ù‚Ø±Ø¨ ÙˆÙ‚Øª Ù…Ù…ÙƒÙ†</p>
                    </div>

                    <div class="error-message" id="error-message">
                        <i class="fas fa-exclamation-circle"></i>
                        <h3 id="error-title">Ø­Ø¯Ø« Ø®Ø·Ø£</h3>
                        <p id="error-details">ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰</p>
                    </div>

                    <form id="support-form">
                        <div class="form-group">
                            <label for="ticket_category">Ù†ÙˆØ¹ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©:</label>
                            <select id="ticket_category" name="category" required>
                                <option value="">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©</option>
                                <option value="technical">Ù…Ø´ÙƒÙ„Ø© ÙÙ†ÙŠØ©</option>
                                <option value="account">Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø­Ø³Ø§Ø¨</option>
                                <option value="payment">Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø¯ÙØ¹</option>
                                <option value="general">Ø§Ø³ØªÙØ³Ø§Ø± Ø¹Ø§Ù…</option>
                                <option value="bug">Ø¨Ù„Ø§Øº Ø¹Ù† Ø®Ø·Ø£</option>
                                <option value="suggestion">Ø§Ù‚ØªØ±Ø§Ø­</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="ticket_priority">Ø£ÙˆÙ„ÙˆÙŠØ© Ø§Ù„Ù…Ø´ÙƒÙ„Ø©:</label>
                            <select id="ticket_priority" name="priority" required>
                                <option value="low">Ù…Ù†Ø®ÙØ¶Ø©</option>
                                <option value="medium" selected>Ù…ØªÙˆØ³Ø·Ø©</option>
                                <option value="high">Ø¹Ø§Ù„ÙŠØ©</option>
                                <option value="urgent">Ø¹Ø§Ø¬Ù„Ø©</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="ticket_subject">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø´ÙƒÙ„Ø©:</label>
                            <input type="text" id="ticket_subject" name="subject" placeholder="Ø§ÙƒØªØ¨ Ø¹Ù†ÙˆØ§Ù†Ø§Ù‹ ÙˆØ§Ø¶Ø­Ø§Ù‹ Ù„Ù„Ù…Ø´ÙƒÙ„Ø©" required>
                        </div>

                        <div class="form-group">
                            <label for="ticket_description">ÙˆØµÙ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©:</label>
                            <textarea id="ticket_description" name="description" placeholder="ØµÙ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ø¨Ø§Ù„ØªÙØµÙŠÙ„ØŒ Ø¨Ù…Ø§ ÙÙŠ Ø°Ù„Ùƒ Ø§Ù„Ø®Ø·ÙˆØ§Øª Ø§Ù„ØªÙŠ ØªØ¤Ø¯ÙŠ Ø¥Ù„Ù‰ Ø­Ø¯ÙˆØ«Ù‡Ø§..." required></textarea>
                        </div>

                        <div class="form-group">
                            <button type="submit" class="submit-btn" id="submit-btn">
                                <i class="fas fa-paper-plane"></i>
                                Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØ°ÙƒØ±Ø©
                            </button>
                            <button type="button" class="submit-btn" onclick="window.closeTicketForm()" style="background: var(--sub-text); margin-right: 10px;">
                                <i class="fas fa-times"></i>
                                Ø¥Ù„ØºØ§Ø¡
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØ°Ø§ÙƒØ± Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© -->
                <div class="tickets-list" id="tickets-list">
                    <h2 style="color: var(--accent); margin-bottom: 25px;">ØªØ°Ø§ÙƒØ± Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</h2>
                    
                    <div class="loading" id="tickets-loading">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ°Ø§ÙƒØ±...</p>
                    </div>

                    <div id="tickets-container">
                        <!-- Ø³ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ°Ø§ÙƒØ± Ù‡Ù†Ø§ -->
                    </div>
                </div>

                <!-- Ù‚Ø³Ù… Ø§Ù„Ø§ØªØµØ§Ù„ -->
                <div id="contact-section"></div>

                <div style="display: flex; gap: 15px; margin-top: 40px; flex-wrap: wrap; justify-content: center;">
                    <a href="index.html" class="back-btn">
                        <i class="fas fa-arrow-right"></i>
                        Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
                    </a>
                    <a href="faq.html" class="back-btn" style="background: linear-gradient(135deg, #666, #999);">
                        <i class="fas fa-question-circle"></i>
                        Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø´Ø§Ø¦Ø¹Ø©
                    </a>
                </div>
            </section>
        </div>
    </main>

    <!-- Ø³ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙˆØªØ± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù‡Ù†Ø§ -->
    <div id="footer-container"></div>

    <!-- Ø§Ù„Ø³ÙƒØ±ÙŠØ¨ØªØ§Øª -->
    <script src="shared/config.js"></script>
    <script src="assets/js/main.js"></script>
    
    <script>
        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØµÙØ­Ø©
        document.addEventListener('DOMContentLoaded', function () {
            initSupabase();

        });
        let currentUser = null;

        // ØªÙ‡ÙŠØ¦Ø© Supabase
        function initSupabase() {
            try {
                if (typeof supabase !== 'undefined' && window.supabaseClient) {
                    console.log('âœ… Supabase initialized for download page');
                } else {
                    console.error('âŒ Supabase client not available');
                }
            } catch (err) {
                console.error('âŒ Supabase init error:', err);
            }
        }

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        function checkSupportAuth() {
            try {
                currentUser = JSON.parse(localStorage.getItem('user') || 'null');
                const authRequired = document.getElementById('auth-required');
                const supportGrid = document.getElementById('support-grid');
                const ticketsList = document.getElementById('tickets-list');

                if (currentUser && currentUser.id) {
                    // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„
                    authRequired.style.display = 'none';
                    supportGrid.style.display = 'grid';
                    ticketsList.style.display = 'block';
                    loadUserTickets();
                } else {
                    // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…Ø³Ø¬Ù„
                    authRequired.style.display = 'block';
                    supportGrid.style.display = 'none';
                    ticketsList.style.display = 'none';
                }
            } catch (error) {
                console.error('Error in checkSupportAuth:', error);
            }
        }

        // ÙØªØ­ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ØªØ°ÙƒØ±Ø©
        window.openTicketForm = function(category) {
            console.log('Opening ticket form for category:', category);
            
            if (!currentUser || !currentUser.id) {
                if (typeof window.openUserModal === 'function') {
                    window.openUserModal();
                } else {
                    alert('ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹');
                }
                return;
            }

            document.getElementById('ticket-form').style.display = 'block';
            document.getElementById('ticket_category').value = category;
            document.getElementById('support-grid').style.display = 'none';
            document.getElementById('success-message').style.display = 'none';
            document.getElementById('error-message').style.display = 'none';
        }

        // Ø¥ØºÙ„Ø§Ù‚ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ØªØ°ÙƒØ±Ø©
        window.closeTicketForm = function() {
            document.getElementById('ticket-form').style.display = 'none';
            document.getElementById('support-grid').style.display = 'grid';
            document.getElementById('support-form').reset();
        }

        // Ø¥Ø±Ø³Ø§Ù„ ØªØ°ÙƒØ±Ø© Ø§Ù„Ø¯Ø¹Ù…
        async function submitSupportTicket(event) {
            event.preventDefault();
            
            if (!currentUser || !currentUser.id) {
                showError('ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„', 'ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹ Ù„Ø¥Ø±Ø³Ø§Ù„ ØªØ°ÙƒØ±Ø© Ø§Ù„Ø¯Ø¹Ù…');
                return;
            }

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙ‡ÙŠØ¦Ø© Supabase
            if (!supabaseClient) {
                showError('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„', 'Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹');
                return;
            }

            const submitBtn = document.getElementById('submit-btn');
            const originalText = submitBtn.innerHTML;
            
            try {
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...';
                submitBtn.disabled = true;

                const formData = new FormData(event.target);
                const ticketData = {
                    user_id: currentUser.id,
                    user_email: currentUser.email || 'unknown@example.com',
                    user_name: currentUser.name || 'Ù…Ø³ØªØ®Ø¯Ù…',
                    category: formData.get('category'),
                    priority: formData.get('priority'),
                    subject: formData.get('subject'),
                    description: formData.get('description'),
                    status: 'open',
                    created_at: new Date().toISOString()
                };

                console.log('ğŸ“¤ Sending ticket data:', ticketData);

                const { data, error } = await supabaseClient
                    .from('support_tickets')
                    .insert([ticketData])
                    .select();

                if (error) {
                    console.error('âŒ Supabase error:', error);
                    throw new Error(error.message);
                }

                console.log('âœ… Ticket submitted successfully:', data);
                showSuccess();
                window.closeTicketForm();
                loadUserTickets();

            } catch (error) {
                console.error('âŒ Error submitting ticket:', error);
                showError('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„', error.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØ°ÙƒØ±Ø©. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
            } finally {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        }

        // ØªØ­Ù…ÙŠÙ„ ØªØ°Ø§ÙƒØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        async function loadUserTickets() {
            if (!currentUser || !currentUser.id || !supabaseClient) {
                console.log('âš ï¸ Cannot load tickets: missing user or supabase client');
                return;
            }

            const loadingElement = document.getElementById('tickets-loading');
            const ticketsContainer = document.getElementById('tickets-container');

            try {
                loadingElement.style.display = 'block';
                ticketsContainer.innerHTML = '';

                console.log('ğŸ“¥ Loading tickets for user:', currentUser.id);

                const { data: tickets, error } = await supabaseClient
                    .from('support_tickets')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false });

                if (error) {
                    console.error('âŒ Supabase error:', error);
                    throw new Error(error.message);
                }

                console.log('âœ… Tickets loaded:', tickets);

                if (tickets && tickets.length > 0) {
                    tickets.forEach(ticket => {
                        const ticketElement = createTicketElement(ticket);
                        ticketsContainer.appendChild(ticketElement);
                    });
                } else {
                    ticketsContainer.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: var(--sub-text);">
                            <i class="fas fa-inbox" style="font-size: 48px; margin-bottom: 15px;"></i>
                            <h3>Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ°Ø§ÙƒØ± Ø³Ø§Ø¨Ù‚Ø©</h3>
                            <p>Ù„Ù… ØªÙ‚Ù… Ø¨Ø¥Ø±Ø³Ø§Ù„ Ø£ÙŠ ØªØ°Ø§ÙƒØ± Ø¯Ø¹Ù… Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†</p>
                        </div>
                    `;
                }

            } catch (error) {
                console.error('âŒ Error loading tickets:', error);
                ticketsContainer.innerHTML = `
                    <div class="error-message" style="display: block;">
                        <i class="fas fa-exclamation-circle"></i>
                        <h3>Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ°Ø§ÙƒØ±</h3>
                        <p>${error.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ°Ø§ÙƒØ± Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©'}</p>
                    </div>
                `;
            } finally {
                loadingElement.style.display = 'none';
            }
        }

        // Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù†ØµØ± Ø§Ù„ØªØ°ÙƒØ±Ø©
        function createTicketElement(ticket) {
            const ticketDiv = document.createElement('div');
            ticketDiv.className = 'ticket-item';
            
            const statusClass = `status-${ticket.status.replace(' ', '-')}`;
            const statusText = getStatusText(ticket.status);
            const priorityText = getPriorityText(ticket.priority);
            const date = new Date(ticket.created_at).toLocaleDateString('ar-LY');

            ticketDiv.innerHTML = `
                <div class="ticket-header">
                    <h3 class="ticket-title">${ticket.subject}</h3>
                    <div class="ticket-meta">
                        <span class="ticket-status ${statusClass}">${statusText}</span>
                        <span class="ticket-date">${date}</span>
                        <span class="ticket-priority">Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©: ${priorityText}</span>
                    </div>
                </div>
                <div class="ticket-description">
                    <p>${ticket.description}</p>
                </div>
                ${ticket.admin_response ? `
                <div class="ticket-response">
                    <div class="response-header">
                        <span class="response-author">Ø±Ø¯ Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ</span>
                        <span class="response-date">${new Date(ticket.updated_at).toLocaleDateString('ar-LY')}</span>
                    </div>
                    <div class="response-content">
                        <p>${ticket.admin_response}</p>
                    </div>
                </div>
                ` : ''}
            `;

            return ticketDiv;
        }

        // Ù†ØµÙˆØµ Ø§Ù„Ø­Ø§Ù„Ø©
        function getStatusText(status) {
            const statusMap = {
                'open': 'Ù…ÙØªÙˆØ­Ø©',
                'in-progress': 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©',
                'resolved': 'ØªÙ… Ø§Ù„Ø­Ù„',
                'closed': 'Ù…ØºÙ„Ù‚Ø©'
            };
            return statusMap[status] || status;
        }

        // Ù†ØµÙˆØµ Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©
        function getPriorityText(priority) {
            const priorityMap = {
                'low': 'Ù…Ù†Ø®ÙØ¶Ø©',
                'medium': 'Ù…ØªÙˆØ³Ø·Ø©',
                'high': 'Ø¹Ø§Ù„ÙŠØ©',
                'urgent': 'Ø¹Ø§Ø¬Ù„Ø©'
            };
            return priorityMap[priority] || priority;
        }

        // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­
        function showSuccess() {
            const successMessage = document.getElementById('success-message');
            successMessage.style.display = 'block';
            setTimeout(() => {
                successMessage.style.display = 'none';
            }, 5000);
        }

        // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£
        function showError(title, message) {
            const errorMessage = document.getElementById('error-message');
            document.getElementById('error-title').textContent = title;
            document.getElementById('error-details').textContent = message;
            errorMessage.style.display = 'block';
            setTimeout(() => {
                errorMessage.style.display = 'none';
            }, 5000);
        }

        // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹Ø§Øª Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
        function setupEventListeners() {
            // Ù…Ø³ØªÙ…Ø¹ Ù„Ù„Ù†Ù…ÙˆØ°Ø¬
            const supportForm = document.getElementById('support-form');
            if (supportForm) {
                supportForm.addEventListener('submit', submitSupportTicket);
            }

            // Ù…Ø³ØªÙ…Ø¹ Ù„Ø£Ø²Ø±Ø§Ø± ÙØªØ­ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
            const supportButtons = document.querySelectorAll('.support-card .submit-btn');
            supportButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const category = this.getAttribute('data-category');
                    window.openTicketForm(category);
                });
            });
        }

        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØµÙØ­Ø©
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ Initializing support page...');
            
            // ØªÙ‡ÙŠØ¦Ø© Supabase
            const supabaseInitialized = initSupabase();
            
            if (!supabaseInitialized) {
                showError('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©', 'ØªØ¹Ø°Ø± ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯Ø¹Ù…. ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©.');
            }
            
            // Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø³ØªÙ…Ø¹Ø§Øª Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
            setupEventListeners();
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            checkSupportAuth();
            
            // ØªØ­Ø¯ÙŠØ« Ø¯ÙˆØ±ÙŠ Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            setInterval(checkSupportAuth, 3000);
        });
    </script>
</body>
</html>
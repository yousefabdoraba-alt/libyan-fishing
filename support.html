<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>الدعم الفني - دليل الصيد الليبي</title>
    
    <!-- خطوط وأيقونات -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.38.0/dist/umd/supabase.min.js"></script>

    <!-- الأنماط -->
    <link rel="stylesheet" href="assets/css/style.css">
    
    <style>
        /* أنماط الدعم الفني - نفس الأنماط السابقة */
        .support-content {
            padding: 80px 0 60px;
        }

        .support-header {
            text-align: center;
            margin-bottom: 50px;
        }

        .support-header h1 {
            font-size: 42px;
            font-weight: 900;
            margin-bottom: 14px;
            background: linear-gradient(135deg, var(--accent), var(--primary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .support-header p {
            color: var(--sub-text);
            font-size: 18px;
            max-width: 600px;
            margin: 0 auto;
        }

        .auth-required {
            background: linear-gradient(135deg, rgba(255, 152, 0, 0.1), rgba(255, 152, 0, 0.05));
            border: 2px solid #ff9800;
            border-radius: var(--radius);
            padding: 30px;
            text-align: center;
            margin-bottom: 40px;
            display: none;
        }

        .auth-required i {
            font-size: 48px;
            color: #ff9800;
            margin-bottom: 15px;
        }

        .support-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .support-card {
            background: var(--card-bg);
            padding: 30px;
            border-radius: var(--radius);
            text-align: center;
            box-shadow: 0 5px 15px var(--shadow);
            transition: var(--transition);
            border: 1px solid var(--border);
        }

        .support-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px var(--shadow-hover);
        }

        .support-card i {
            font-size: 48px;
            margin-bottom: 20px;
        }

        .support-card.technical i { color: #2196F3; }
        .support-card.account i { color: #4CAF50; }
        .support-card.payment i { color: #FF9800; }
        .support-card.general i { color: #9C27B0; }

        .support-card h3 {
            color: var(--accent);
            margin-bottom: 15px;
        }

        .support-card p {
            color: var(--sub-text);
            margin-bottom: 20px;
        }

        .ticket-form {
            background: var(--card-bg);
            padding: 30px;
            border-radius: var(--radius);
            box-shadow: 0 5px 15px var(--shadow);
            margin-bottom: 40px;
            display: none;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--border);
            border-radius: var(--radius);
            background: var(--card-bg);
            color: var(--text);
            font-size: 16px;
            font-family: "Tajawal", sans-serif;
            transition: var(--transition);
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(25, 118, 243, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 120px;
        }

        .submit-btn {
            background: linear-gradient(135deg, var(--primary), var(--accent));
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: var(--radius);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            font-family: "Tajawal", sans-serif;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(25, 118, 243, 0.3);
        }

        .submit-btn:disabled {
            background: var(--sub-text);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .tickets-list {
            display: none;
        }

        .ticket-item {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px var(--shadow);
            border-left: 4px solid var(--primary);
        }

        .ticket-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .ticket-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text);
            margin: 0;
        }

        .ticket-meta {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .ticket-status {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        .status-open { background: #E3F2FD; color: #1976D2; }
        .status-in-progress { background: #FFF3E0; color: #F57C00; }
        .status-resolved { background: #E8F5E8; color: #2E7D32; }
        .status-closed { background: #F5F5F5; color: #616161; }

        .ticket-date {
            color: var(--sub-text);
            font-size: 14px;
        }

        .ticket-description {
            color: var(--text);
            line-height: 1.6;
            margin-bottom: 15px;
        }

        .ticket-response {
            background: rgba(25, 118, 243, 0.05);
            border-radius: var(--radius);
            padding: 20px;
            margin-top: 15px;
            border-right: 3px solid var(--primary);
        }

        .response-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .response-author {
            font-weight: 600;
            color: var(--primary);
        }

        .response-date {
            color: var(--sub-text);
            font-size: 14px;
        }

        .response-content {
            color: var(--text);
            line-height: 1.6;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--sub-text);
        }

        .loading i {
            font-size: 48px;
            margin-bottom: 15px;
            color: var(--primary);
        }

        .success-message {
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.1), rgba(76, 175, 80, 0.05));
            border: 2px solid #4CAF50;
            border-radius: var(--radius);
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
            display: none;
        }

        .error-message {
            background: linear-gradient(135deg, rgba(244, 67, 54, 0.1), rgba(244, 67, 54, 0.05));
            border: 2px solid #f44336;
            border-radius: var(--radius);
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
            display: none;
        }

        @media (max-width: 900px) {
            .support-header h1 {
                font-size: 32px;
            }
            
            .support-grid {
                grid-template-columns: 1fr;
            }
            
            .ticket-header {
                flex-direction: column;
                align-items: flex-start;
            }
        }

        @media (max-width:768px) {
            .ticket-form,
            .support-card {
                padding: 20px;
            }
            
            .ticket-item {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- سيتم تحميل الهيدر تلقائياً هنا -->
    <div id="header-container"></div>

    <!-- محتوى الصفحة -->
    <main class="page-content">
        <div class="container">
            <section class="support-content">
                <div class="support-header">
                    <h1>الدعم الفني</h1>
                    <p>نحن هنا لمساعدتك! اختر نوع المشكلة أو أرسل تذكرة دعم جديدة</p>
                </div>

                <!-- رسالة طلب تسجيل الدخول -->
                <div class="auth-required" id="auth-required">
                    <i class="fas fa-user-lock"></i>
                    <h3>يجب تسجيل الدخول</h3>
                    <p>يجب أن تكون مسجلاً الدخول لاستخدام خدمة الدعم الفني</p>
                    <button class="submit-btn" onclick="window.openUserModal()" style="margin-top: 15px;">
                        <i class="fas fa-sign-in-alt"></i>
                        تسجيل الدخول
                    </button>
                </div>

                <!-- شبكة خيارات الدعم -->
                <div class="support-grid" id="support-grid">
                    <div class="support-card technical" data-category="technical">
                        <i class="fas fa-cogs"></i>
                        <h3>مشاكل فنية</h3>
                        <p>مشاكل في التطبيق، الأخطاء، مشاكل الأداء</p>
                        <button class="submit-btn" data-category="technical">
                            <i class="fas fa-paper-plane"></i>
                            إبلاغ عن مشكلة
                        </button>
                    </div>

                    <div class="support-card account" data-category="account">
                        <i class="fas fa-user-circle"></i>
                        <h3>مشاكل الحساب</h3>
                        <p>تسجيل الدخول، استعادة كلمة المرور، إدارة الحساب</p>
                        <button class="submit-btn" data-category="account">
                            <i class="fas fa-paper-plane"></i>
                            إبلاغ عن مشكلة
                        </button>
                    </div>

                    <div class="support-card payment" data-category="payment">
                        <i class="fas fa-credit-card"></i>
                        <h3>مشاكل الدفع</h3>
                        <p>الاشتراكات، الفواتير، استرداد المبالغ</p>
                        <button class="submit-btn" data-category="payment">
                            <i class="fas fa-paper-plane"></i>
                            إبلاغ عن مشكلة
                        </button>
                    </div>

                    <div class="support-card general" data-category="general">
                        <i class="fas fa-question-circle"></i>
                        <h3>استفسارات عامة</h3>
                        <p>أسئلة، اقتراحات، استفسارات أخرى</p>
                        <button class="submit-btn" data-category="general">
                            <i class="fas fa-paper-plane"></i>
                            إرسال استفسار
                        </button>
                    </div>
                </div>

                <!-- نموذج إرسال تذكرة -->
                <div class="ticket-form" id="ticket-form">
                    <h2 style="color: var(--accent); margin-bottom: 25px;">إرسال تذكرة دعم جديدة</h2>
                    
                    <div class="success-message" id="success-message">
                        <i class="fas fa-check-circle"></i>
                        <h3>تم إرسال التذكرة بنجاح!</h3>
                        <p>سيقوم فريق الدعم بالرد عليك في أقرب وقت ممكن</p>
                    </div>

                    <div class="error-message" id="error-message">
                        <i class="fas fa-exclamation-circle"></i>
                        <h3 id="error-title">حدث خطأ</h3>
                        <p id="error-details">يرجى المحاولة مرة أخرى</p>
                    </div>

                    <form id="support-form">
                        <div class="form-group">
                            <label for="ticket_category">نوع المشكلة:</label>
                            <select id="ticket_category" name="category" required>
                                <option value="">اختر نوع المشكلة</option>
                                <option value="technical">مشكلة فنية</option>
                                <option value="account">مشكلة في الحساب</option>
                                <option value="payment">مشكلة في الدفع</option>
                                <option value="general">استفسار عام</option>
                                <option value="bug">بلاغ عن خطأ</option>
                                <option value="suggestion">اقتراح</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="ticket_priority">أولوية المشكلة:</label>
                            <select id="ticket_priority" name="priority" required>
                                <option value="low">منخفضة</option>
                                <option value="medium" selected>متوسطة</option>
                                <option value="high">عالية</option>
                                <option value="urgent">عاجلة</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="ticket_subject">عنوان المشكلة:</label>
                            <input type="text" id="ticket_subject" name="subject" placeholder="اكتب عنواناً واضحاً للمشكلة" required>
                        </div>

                        <div class="form-group">
                            <label for="ticket_description">وصف المشكلة:</label>
                            <textarea id="ticket_description" name="description" placeholder="صف المشكلة بالتفصيل، بما في ذلك الخطوات التي تؤدي إلى حدوثها..." required></textarea>
                        </div>

                        <div class="form-group">
                            <button type="submit" class="submit-btn" id="submit-btn">
                                <i class="fas fa-paper-plane"></i>
                                إرسال التذكرة
                            </button>
                            <button type="button" class="submit-btn" onclick="window.closeTicketForm()" style="background: var(--sub-text); margin-right: 10px;">
                                <i class="fas fa-times"></i>
                                إلغاء
                            </button>
                        </div>
                    </form>
                </div>

                <!-- قائمة التذاكر السابقة -->
                <div class="tickets-list" id="tickets-list">
                    <h2 style="color: var(--accent); margin-bottom: 25px;">تذاكر الدعم السابقة</h2>
                    
                    <div class="loading" id="tickets-loading">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>جاري تحميل التذاكر...</p>
                    </div>

                    <div id="tickets-container">
                        <!-- سيتم تحميل التذاكر هنا -->
                    </div>
                </div>

                <!-- قسم الاتصال -->
                <div id="contact-section"></div>

                <div style="display: flex; gap: 15px; margin-top: 40px; flex-wrap: wrap; justify-content: center;">
                    <a href="index.html" class="back-btn">
                        <i class="fas fa-arrow-right"></i>
                        العودة إلى الصفحة الرئيسية
                    </a>
                    <a href="faq.html" class="back-btn" style="background: linear-gradient(135deg, #666, #999);">
                        <i class="fas fa-question-circle"></i>
                        الأسئلة الشائعة
                    </a>
                </div>
            </section>
        </div>
    </main>

    <!-- سيتم تحميل الفوتر تلقائياً هنا -->
    <div id="footer-container"></div>

    <!-- السكريبتات -->
    <script src="shared/config.js"></script>
    <script src="assets/js/main.js"></script>
    
    <script>
        // تهيئة الصفحة
        document.addEventListener('DOMContentLoaded', function () {
            initSupabase();

        });
        let currentUser = null;

        // تهيئة Supabase
        function initSupabase() {
            try {
                if (typeof supabase !== 'undefined' && window.supabaseClient) {
                    console.log('✅ Supabase initialized for download page');
                } else {
                    console.error('❌ Supabase client not available');
                }
            } catch (err) {
                console.error('❌ Supabase init error:', err);
            }
        }

        // التحقق من حالة المستخدم
        function checkSupportAuth() {
            try {
                currentUser = JSON.parse(localStorage.getItem('user') || 'null');
                const authRequired = document.getElementById('auth-required');
                const supportGrid = document.getElementById('support-grid');
                const ticketsList = document.getElementById('tickets-list');

                if (currentUser && currentUser.id) {
                    // المستخدم مسجل الدخول
                    authRequired.style.display = 'none';
                    supportGrid.style.display = 'grid';
                    ticketsList.style.display = 'block';
                    loadUserTickets();
                } else {
                    // المستخدم غير مسجل
                    authRequired.style.display = 'block';
                    supportGrid.style.display = 'none';
                    ticketsList.style.display = 'none';
                }
            } catch (error) {
                console.error('Error in checkSupportAuth:', error);
            }
        }

        // فتح نموذج التذكرة
        window.openTicketForm = function(category) {
            console.log('Opening ticket form for category:', category);
            
            if (!currentUser || !currentUser.id) {
                if (typeof window.openUserModal === 'function') {
                    window.openUserModal();
                } else {
                    alert('يجب تسجيل الدخول أولاً');
                }
                return;
            }

            document.getElementById('ticket-form').style.display = 'block';
            document.getElementById('ticket_category').value = category;
            document.getElementById('support-grid').style.display = 'none';
            document.getElementById('success-message').style.display = 'none';
            document.getElementById('error-message').style.display = 'none';
        }

        // إغلاق نموذج التذكرة
        window.closeTicketForm = function() {
            document.getElementById('ticket-form').style.display = 'none';
            document.getElementById('support-grid').style.display = 'grid';
            document.getElementById('support-form').reset();
        }

        // إرسال تذكرة الدعم
        async function submitSupportTicket(event) {
            event.preventDefault();
            
            if (!currentUser || !currentUser.id) {
                showError('يجب تسجيل الدخول', 'يرجى تسجيل الدخول أولاً لإرسال تذكرة الدعم');
                return;
            }

            // التحقق من تهيئة Supabase
            if (!supabaseClient) {
                showError('خطأ في الاتصال', 'لا يمكن الاتصال بقاعدة البيانات حالياً');
                return;
            }

            const submitBtn = document.getElementById('submit-btn');
            const originalText = submitBtn.innerHTML;
            
            try {
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري الإرسال...';
                submitBtn.disabled = true;

                const formData = new FormData(event.target);
                const ticketData = {
                    user_id: currentUser.id,
                    user_email: currentUser.email || 'unknown@example.com',
                    user_name: currentUser.name || 'مستخدم',
                    category: formData.get('category'),
                    priority: formData.get('priority'),
                    subject: formData.get('subject'),
                    description: formData.get('description'),
                    status: 'open',
                    created_at: new Date().toISOString()
                };

                console.log('📤 Sending ticket data:', ticketData);

                const { data, error } = await supabaseClient
                    .from('support_tickets')
                    .insert([ticketData])
                    .select();

                if (error) {
                    console.error('❌ Supabase error:', error);
                    throw new Error(error.message);
                }

                console.log('✅ Ticket submitted successfully:', data);
                showSuccess();
                window.closeTicketForm();
                loadUserTickets();

            } catch (error) {
                console.error('❌ Error submitting ticket:', error);
                showError('خطأ في الإرسال', error.message || 'حدث خطأ أثناء إرسال التذكرة. يرجى المحاولة مرة أخرى.');
            } finally {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        }

        // تحميل تذاكر المستخدم
        async function loadUserTickets() {
            if (!currentUser || !currentUser.id || !supabaseClient) {
                console.log('⚠️ Cannot load tickets: missing user or supabase client');
                return;
            }

            const loadingElement = document.getElementById('tickets-loading');
            const ticketsContainer = document.getElementById('tickets-container');

            try {
                loadingElement.style.display = 'block';
                ticketsContainer.innerHTML = '';

                console.log('📥 Loading tickets for user:', currentUser.id);

                const { data: tickets, error } = await supabaseClient
                    .from('support_tickets')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false });

                if (error) {
                    console.error('❌ Supabase error:', error);
                    throw new Error(error.message);
                }

                console.log('✅ Tickets loaded:', tickets);

                if (tickets && tickets.length > 0) {
                    tickets.forEach(ticket => {
                        const ticketElement = createTicketElement(ticket);
                        ticketsContainer.appendChild(ticketElement);
                    });
                } else {
                    ticketsContainer.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: var(--sub-text);">
                            <i class="fas fa-inbox" style="font-size: 48px; margin-bottom: 15px;"></i>
                            <h3>لا توجد تذاكر سابقة</h3>
                            <p>لم تقم بإرسال أي تذاكر دعم حتى الآن</p>
                        </div>
                    `;
                }

            } catch (error) {
                console.error('❌ Error loading tickets:', error);
                ticketsContainer.innerHTML = `
                    <div class="error-message" style="display: block;">
                        <i class="fas fa-exclamation-circle"></i>
                        <h3>خطأ في تحميل التذاكر</h3>
                        <p>${error.message || 'حدث خطأ أثناء تحميل التذاكر السابقة'}</p>
                    </div>
                `;
            } finally {
                loadingElement.style.display = 'none';
            }
        }

        // إنشاء عنصر التذكرة
        function createTicketElement(ticket) {
            const ticketDiv = document.createElement('div');
            ticketDiv.className = 'ticket-item';
            
            const statusClass = `status-${ticket.status.replace(' ', '-')}`;
            const statusText = getStatusText(ticket.status);
            const priorityText = getPriorityText(ticket.priority);
            const date = new Date(ticket.created_at).toLocaleDateString('ar-LY');

            ticketDiv.innerHTML = `
                <div class="ticket-header">
                    <h3 class="ticket-title">${ticket.subject}</h3>
                    <div class="ticket-meta">
                        <span class="ticket-status ${statusClass}">${statusText}</span>
                        <span class="ticket-date">${date}</span>
                        <span class="ticket-priority">الأولوية: ${priorityText}</span>
                    </div>
                </div>
                <div class="ticket-description">
                    <p>${ticket.description}</p>
                </div>
                ${ticket.admin_response ? `
                <div class="ticket-response">
                    <div class="response-header">
                        <span class="response-author">رد الدعم الفني</span>
                        <span class="response-date">${new Date(ticket.updated_at).toLocaleDateString('ar-LY')}</span>
                    </div>
                    <div class="response-content">
                        <p>${ticket.admin_response}</p>
                    </div>
                </div>
                ` : ''}
            `;

            return ticketDiv;
        }

        // نصوص الحالة
        function getStatusText(status) {
            const statusMap = {
                'open': 'مفتوحة',
                'in-progress': 'قيد المعالجة',
                'resolved': 'تم الحل',
                'closed': 'مغلقة'
            };
            return statusMap[status] || status;
        }

        // نصوص الأولوية
        function getPriorityText(priority) {
            const priorityMap = {
                'low': 'منخفضة',
                'medium': 'متوسطة',
                'high': 'عالية',
                'urgent': 'عاجلة'
            };
            return priorityMap[priority] || priority;
        }

        // عرض رسالة النجاح
        function showSuccess() {
            const successMessage = document.getElementById('success-message');
            successMessage.style.display = 'block';
            setTimeout(() => {
                successMessage.style.display = 'none';
            }, 5000);
        }

        // عرض رسالة الخطأ
        function showError(title, message) {
            const errorMessage = document.getElementById('error-message');
            document.getElementById('error-title').textContent = title;
            document.getElementById('error-details').textContent = message;
            errorMessage.style.display = 'block';
            setTimeout(() => {
                errorMessage.style.display = 'none';
            }, 5000);
        }

        // إضافة مستمعات الأحداث
        function setupEventListeners() {
            // مستمع للنموذج
            const supportForm = document.getElementById('support-form');
            if (supportForm) {
                supportForm.addEventListener('submit', submitSupportTicket);
            }

            // مستمع لأزرار فتح النموذج
            const supportButtons = document.querySelectorAll('.support-card .submit-btn');
            supportButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const category = this.getAttribute('data-category');
                    window.openTicketForm(category);
                });
            });
        }

        // تهيئة الصفحة
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Initializing support page...');
            
            // تهيئة Supabase
            const supabaseInitialized = initSupabase();
            
            if (!supabaseInitialized) {
                showError('خطأ في التهيئة', 'تعذر تهيئة نظام الدعم. يرجى تحديث الصفحة.');
            }
            
            // إعداد مستمعات الأحداث
            setupEventListeners();
            
            // التحقق من حالة المستخدم
            checkSupportAuth();
            
            // تحديث دوري لحالة المستخدم
            setInterval(checkSupportAuth, 3000);
        });
    </script>
</body>
</html>